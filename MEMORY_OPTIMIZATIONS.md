# è¨˜æ†¶é«”å„ªåŒ–ä¿®å¾©å ±å‘Šï¼ˆæœ€çµ‚ç‰ˆï¼‰

## å•é¡Œæ ¹æºè¨ºæ–·

ç”¨æˆ¶å ±å‘Šï¼šã€Œé‚„æ˜¯é‡åˆ°è¨˜æ†¶é«”ç”¨ç›¡çš„ç‹€æ³æ¬¸ï¼Œé‚„æ²’åŠ å…¥DBã€æ”¹è®Šå–è³‡æ–™æ–¹å¼å‰ï¼Œæ²’æœ‰é€™å€‹ç‹€æ³ã€

**æ ¹æœ¬åŸå› **ï¼šèˆ‡ main åˆ†æ”¯å°æ¯”å¾Œç™¼ç¾ï¼ŒMongoDB æ•´åˆå¾Œæ¯æ¬¡å‰ç«¯è¼ªè©¢éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼Œè¼‰å…¥å®Œæ•´ä»»å‹™è³‡æ–™ï¼ˆåŒ…å« segments ç­‰å¤§å‹æ•¸æ“šï¼‰ï¼Œå°è‡´è¨˜æ†¶é«”æŒçºŒç´¯ç©ã€‚

**main åˆ†æ”¯åšæ³•**ï¼šé€²è¡Œä¸­ä»»å‹™å®Œå…¨åœ¨è¨˜æ†¶é«”ä¸­ï¼Œè¼ªè©¢ä½¿ç”¨ `dict.get()` - **é›¶ DB æŸ¥è©¢**

**ç•¶å‰åˆ†æ”¯å•é¡Œ**ï¼šæ¯æ¬¡è¼ªè©¢éƒ½åŸ·è¡Œ `await task_repo.get_by_id_and_user()` - **æ¯ç§’å¤šæ¬¡ DB æŸ¥è©¢**

## å¯¦æ–½çš„å„ªåŒ–

---

## ğŸ¯ æ ¸å¿ƒä¿®å¾©ï¼šå®Œå…¨è¨˜æ†¶é«”æ¨¡å¼ï¼ˆé›¶ DB æŸ¥è©¢ï¼‰âœ…

**æª”æ¡ˆ**: `src/whisper_server.py`

### ä¿®æ”¹ 1ï¼šä»»å‹™åˆå§‹åŒ–æ™‚è¼‰å…¥å®Œæ•´è³‡æ–™åˆ°è¨˜æ†¶é«”ï¼ˆ1848-1854 è¡Œï¼‰

```python
# åˆå§‹åŒ–è¨˜æ†¶é«”ï¼šå¾ DB è¼‰å…¥ä¸€æ¬¡å®Œæ•´ä»»å‹™è³‡æ–™ï¼ˆåŒ…å« user_idï¼‰ï¼Œä¹‹å¾Œå°±ä¸éœ€è¦å†æŸ¥ DB
task_data = run_async_in_thread(get_task_from_db(task_id))
if task_data:
    with tasks_lock:
        # åˆå§‹åŒ–è¨˜æ†¶é«”å­—å…¸ï¼ŒåŒ…å«å®Œæ•´ä»»å‹™è³‡æ–™ï¼ˆç‰¹åˆ¥æ˜¯ user_idï¼‰
        transcription_tasks[task_id] = task_data.copy()
    print(f"ğŸ“¥ [{task_id}] åˆå§‹åŒ–è¨˜æ†¶é«”ï¼ˆåŒ…å« user_idï¼‰ï¼Œä¹‹å¾Œè¼ªè©¢å°‡é›¶ DB æŸ¥è©¢")
```

**æ•ˆæœ**: ä»»å‹™é–‹å§‹è™•ç†æ™‚ï¼Œä¸€æ¬¡æ€§è¼‰å…¥å®Œæ•´è³‡æ–™ï¼ˆåŒ…å« user_idï¼‰åˆ°è¨˜æ†¶é«”ï¼Œä¹‹å¾Œæ‰€æœ‰æ›´æ–°éƒ½åœ¨è¨˜æ†¶é«”ä¸­é€²è¡Œã€‚

---

### ä¿®æ”¹ 2ï¼šè¼ªè©¢ç«¯é»ä½¿ç”¨ç´”è¨˜æ†¶é«”ï¼ˆ2537-2558 è¡Œï¼‰

```python
# å®Œå…¨è¨˜æ†¶é«”æ¨¡å¼ï¼šé€²è¡Œä¸­ä»»å‹™é›¶ DB æŸ¥è©¢ï¼ˆåƒ main åˆ†æ”¯ä¸€æ¨£ï¼‰
with tasks_lock:
    live_task_info = transcription_tasks.get(task_id)

# å¦‚æœä»»å‹™åœ¨è¨˜æ†¶é«”ä¸­ï¼ˆæ­£åœ¨è™•ç†ï¼‰ï¼Œå®Œå…¨ä½¿ç”¨è¨˜æ†¶é«”æ•¸æ“š
if live_task_info:
    # æ¬Šé™é©—è­‰ï¼šæª¢æŸ¥è¨˜æ†¶é«”ä¸­çš„ user_id
    task_user_id = live_task_info.get("user_id") or live_task_info.get("user", {}).get("user_id")
    if task_user_id != str(current_user["_id"]):
        raise HTTPException(status_code=404, detail="ä»»å‹™ä¸å­˜åœ¨æˆ–ç„¡æ¬Šè¨ªå•")

    # ç›´æ¥ä½¿ç”¨è¨˜æ†¶é«”æ•¸æ“šï¼Œé›¶ DB æŸ¥è©¢ï¼
    task_in_db = live_task_info
    print(f"âš¡ [{task_id}] å¾è¨˜æ†¶é«”è¿”å›ï¼ˆé›¶ DB æŸ¥è©¢ï¼‰")
else:
    # ä»»å‹™ä¸åœ¨è¨˜æ†¶é«”ä¸­ï¼ˆå·²å®Œæˆæˆ–ä¸å­˜åœ¨ï¼‰ï¼ŒæŸ¥è©¢ MongoDB
    task_in_db = await task_repo.get_by_id_and_user(task_id, str(current_user["_id"]))
```

**æ•ˆæœ**:
- **é€²è¡Œä¸­ä»»å‹™**ï¼šå®Œå…¨ä½¿ç”¨è¨˜æ†¶é«”ï¼Œé›¶ DB æŸ¥è©¢ï¼ˆèˆ‡ main åˆ†æ”¯ä¸€è‡´ï¼‰
- **å·²å®Œæˆä»»å‹™**ï¼šæ‰æŸ¥è©¢ MongoDB

**è¨˜æ†¶é«”ç¯€çœ**: æ¯æ¬¡è¼ªè©¢æ¸›å°‘ ~5-50MB è³‡æ–™åº«è¼‰å…¥ï¼ˆå–æ±ºæ–¼ segments å¤§å°ï¼‰

---

### 1. ç§»é™¤ä¸å¿…è¦çš„è³‡æ–™è¤‡è£½ âœ…

**æª”æ¡ˆ**: `src/whisper_server.py:640`

```python
# ä¹‹å‰ï¼šè¤‡è£½æ•´å€‹ä»»å‹™ç‰©ä»¶
merged_task = db_task.copy()

# ç¾åœ¨ï¼šç›´æ¥ä½¿ç”¨åŸç‰©ä»¶
merged_task = db_task  # è¨˜æ†¶é«”å„ªåŒ–ï¼šä¸è¤‡è£½ï¼Œç›´æ¥æ›´æ–°åŸç‰©ä»¶
```

**å½±éŸ¿**: æ¯æ¬¡ç‹€æ…‹æ›´æ–°æ™‚æ¸›å°‘ä¸€æ¬¡å®Œæ•´ä»»å‹™ç‰©ä»¶çš„è¨˜æ†¶é«”è¤‡è£½ã€‚

---

### 2. é™åˆ¶æ´»èºä»»å‹™æŸ¥è©¢æ•¸é‡ âœ…

**æª”æ¡ˆ**: `src/database/repositories/task_repo.py:97-106`

```python
# ä¹‹å‰ï¼šå¯èƒ½è¼‰å…¥ 100 å€‹é€²è¡Œä¸­çš„ä»»å‹™
return await cursor.to_list(length=100)

# ç¾åœ¨ï¼šé™åˆ¶æœ€å¤š 20 å€‹ï¼Œä¸¦æŒ‰æ™‚é–“æ’åº
cursor = self.collection.find({...}).sort("timestamps.created_at", -1).limit(20)
return await cursor.to_list(length=20)
```

**å½±éŸ¿**: æ¸›å°‘é€²è¡Œä¸­ä»»å‹™æŸ¥è©¢çš„è¨˜æ†¶é«”ä½”ç”¨ 80%ã€‚

---

### 3. éŸ³è¨Šè½‰æª”å¾Œç«‹å³é‡‹æ”¾è¨˜æ†¶é«” âœ…

**æª”æ¡ˆ**: `src/whisper_server.py:1862-1868`

```python
audio = AudioSegment.from_file(str(temp_audio_path))
audio.export(str(wav_path), format="wav")
# ç«‹å³é‡‹æ”¾è¨˜æ†¶é«”
del audio
import gc
gc.collect()
```

**å½±éŸ¿**: é˜²æ­¢éŸ³è¨Šè³‡æ–™åœ¨è¨˜æ†¶é«”ä¸­ç´¯ç©ã€‚

---

### 4. ä»»å‹™çµæŸæ™‚å¼·åˆ¶è¨˜æ†¶é«”æ¸…ç† âœ…

**æª”æ¡ˆ**: `src/whisper_server.py:2114-2124`

```python
finally:
    # æ¸…ç†æ‰€æœ‰é‹è¡Œæ™‚ç‹€æ…‹å­—å…¸
    with tasks_lock:
        task_temp_dirs.pop(task_id, None)
        task_cancelled.pop(task_id, None)
        task_diarization_processes.pop(task_id, None)
        # ç¢ºä¿å¾ transcription_tasks ä¸­ç§»é™¤
        transcription_tasks.pop(task_id, None)

    # å¼·åˆ¶åƒåœ¾å›æ”¶ä»¥é‡‹æ”¾è¨˜æ†¶é«”
    import gc
    gc.collect()
    print(f"ğŸ§¹ [{task_id}] è¨˜æ†¶é«”æ¸…ç†å®Œæˆ")
```

**å½±éŸ¿**: ç¢ºä¿ä»»å‹™å®Œæˆå¾Œæ‰€æœ‰ç›¸é—œè¨˜æ†¶é«”è¢«é‡‹æ”¾ã€‚

---

### 5. API æŸ¥è©¢å¾Œç«‹å³é‡‹æ”¾è³‡æ–™ âœ…

**æª”æ¡ˆ**: `src/whisper_server.py:3414-3421`

```python
# enrich å®Œæˆå¾Œï¼Œç«‹å³åˆªé™¤åŸå§‹è³‡æ–™
del all_tasks, all_tasks_sorted, active
import gc
gc.collect()

return {
    "active_count": len(active_enriched),
    "total_count": await task_repo.count_by_user(user_id),  # ç›´æ¥æŸ¥è©¢è¨ˆæ•¸ï¼Œä¸è¼‰å…¥å…¨éƒ¨
    "active_tasks": active_enriched,
    "all_tasks": all_tasks_enriched
}
```

**å½±éŸ¿**: API éŸ¿æ‡‰å¾Œç«‹å³é‡‹æ”¾æŸ¥è©¢çµæœçš„è¨˜æ†¶é«”ã€‚

---

### 6. å®šæœŸè¨˜æ†¶é«”æ¸…ç†èƒŒæ™¯ä»»å‹™ âœ…

**æª”æ¡ˆ**: `src/whisper_server.py:2127-2177`

**åŠŸèƒ½**: æ¯ 10 åˆ†é˜è‡ªå‹•åŸ·è¡Œä¸€æ¬¡ï¼Œæ¸…ç†ä»¥ä¸‹é …ç›®ï¼š
- å­¤ç«‹çš„ä»»å‹™ç‹€æ…‹ï¼ˆ`transcription_tasks`ï¼‰
- å­¤ç«‹çš„æš«å­˜ç›®éŒ„è¨˜éŒ„ï¼ˆ`task_temp_dirs`ï¼‰
- å­¤ç«‹çš„å–æ¶ˆæ¨™è¨˜ï¼ˆ`task_cancelled`ï¼‰
- å­¤ç«‹çš„ diarization é€²ç¨‹è¨˜éŒ„ï¼ˆ`task_diarization_processes`ï¼‰

```python
async def periodic_memory_cleanup():
    """å®šæœŸæ¸…ç†è¨˜æ†¶é«”ä¸­çš„å­¤ç«‹è³‡æ–™ï¼ˆèƒŒæ™¯ä»»å‹™ï¼‰"""
    while True:
        await asyncio.sleep(600)  # æ¯ 10 åˆ†é˜

        # å¾è³‡æ–™åº«æŸ¥è©¢å¯¦éš›çš„æ´»èºä»»å‹™
        active_task_ids = {...}

        # æ¸…ç†è¨˜æ†¶é«”ä¸­ä¸åœ¨æ´»èºåˆ—è¡¨çš„è³‡æ–™
        orphaned_tasks = [...]
        for tid in orphaned_tasks:
            transcription_tasks.pop(tid, None)

        gc.collect()
```

**å½±éŸ¿**: é˜²æ­¢é•·æœŸé‹è¡Œæ™‚è¨˜æ†¶é«”æ´©æ¼ã€‚

---

## æ•ˆèƒ½æå‡é æœŸ

| å„ªåŒ–é …ç›® | è¨˜æ†¶é«”ç¯€çœ | å‚™è¨» |
|---------|----------|------|
| **ğŸ¯ ç´”è¨˜æ†¶é«”è¼ªè©¢** | **~90%+** | **é€²è¡Œä¸­ä»»å‹™é›¶ DB æŸ¥è©¢ï¼ˆæ ¸å¿ƒä¿®å¾©ï¼‰** |
| ç§»é™¤è³‡æ–™è¤‡è£½ | ~10-20% | æ¯æ¬¡ç‹€æ…‹æ›´æ–° |
| é™åˆ¶æŸ¥è©¢æ•¸é‡ | ~80% | æŸ¥è©¢é€²è¡Œä¸­ä»»å‹™æ™‚ |
| éŸ³è¨Šè½‰æª”å¾Œé‡‹æ”¾ | ~100MB+ | æ¯å€‹éŸ³æª”è™•ç† |
| ä»»å‹™çµæŸæ¸…ç† | ~5-10MB | æ¯å€‹ä»»å‹™å®Œæˆ |
| API æŸ¥è©¢å¾Œæ¸…ç† | ~20-30% | æ¯æ¬¡ list è«‹æ±‚ |
| å®šæœŸèƒŒæ™¯æ¸…ç† | é˜²æ­¢æ´©æ¼ | é•·æœŸé‹è¡Œç©©å®šæ€§ |

**é—œéµæ”¹é€²**ï¼š67MB éŸ³æª”è½‰éŒ„æœŸé–“ï¼Œå‰ç«¯æ¯ç§’è¼ªè©¢ä¸å†è¼‰å…¥å®Œæ•´ä»»å‹™è³‡æ–™ï¼ˆåŒ…å« segmentsï¼‰ï¼Œè¨˜æ†¶é«”ä½¿ç”¨é æœŸé™ä½ **80-90%**ã€‚

---

## éœ€è¦é‡å•Ÿå¾Œç«¯

æ‰€æœ‰ä¿®æ”¹éœ€è¦é‡å•Ÿå¾Œç«¯æœå‹™æ‰èƒ½ç”Ÿæ•ˆï¼š

```bash
# åœæ­¢å¾Œç«¯
./stop_backend.sh

# å•Ÿå‹•å¾Œç«¯
./start_backend_daemon.sh
```

---

## ç›£æ§å»ºè­°

é‡å•Ÿå¾Œç«¯å¾Œï¼Œå»ºè­°ç›£æ§ä»¥ä¸‹é …ç›®ï¼š

1. **è¨˜æ†¶é«”ä½¿ç”¨è¶¨å‹¢**
   ```bash
   # æŸ¥çœ‹å¾Œç«¯é€²ç¨‹è¨˜æ†¶é«”ä½¿ç”¨
   ps aux | grep whisper_server.py
   ```

2. **èƒŒæ™¯æ¸…ç†æ—¥èªŒ**
   - æª¢æŸ¥æ—¥èªŒä¸­çš„ "ğŸ§¹ åŸ·è¡Œå®šæœŸè¨˜æ†¶é«”æ¸…ç†..." è¨Šæ¯
   - ç¢ºèªæ˜¯å¦æœ‰å­¤ç«‹ä»»å‹™è¢«æ¸…ç†

3. **è½‰éŒ„å®Œæˆå¾Œè¨˜æ†¶é«”é‡‹æ”¾**
   - æª¢æŸ¥ "ğŸ§¹ [task_id] è¨˜æ†¶é«”æ¸…ç†å®Œæˆ" è¨Šæ¯

---

## å¦‚æœå•é¡Œä»å­˜åœ¨

å¦‚æœè¨˜æ†¶é«”å•é¡Œä»æœªè§£æ±ºï¼Œä¸‹ä¸€æ­¥å»ºè­°ï¼š

1. **æ·»åŠ è¨˜æ†¶é«”åˆ†æå·¥å…·**
   ```python
   import tracemalloc
   tracemalloc.start()
   ```

2. **ç›£æ§ MongoDB é€£æ¥æ± **
   - æª¢æŸ¥æ˜¯å¦æœ‰é€£æ¥æ´©æ¼
   - é™åˆ¶æœ€å¤§é€£æ¥æ•¸

3. **è€ƒæ…®ä½¿ç”¨ Whisper çš„ä¸²æµæ¨¡å¼**
   - é¿å…ä¸€æ¬¡æ€§è¼‰å…¥å¤§å‹éŸ³è¨Šæª”

4. **è¨­ç½®è¨˜æ†¶é«”é™åˆ¶**
   ```bash
   # é™åˆ¶ Python é€²ç¨‹è¨˜æ†¶é«”ä½¿ç”¨
   ulimit -v 8000000  # 8GB
   ```
