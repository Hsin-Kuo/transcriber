# æ­»é–å•é¡Œä¿®å¾©å ±å‘Š

## å•é¡Œç—‡ç‹€

å‰ç«¯è¼ªè©¢è¶…æ™‚ï¼Œå¾Œç«¯é€²ç¨‹å¡ä½ï¼ˆCPU 0%ï¼‰ï¼Œç„¡æ³•å›æ‡‰è«‹æ±‚ã€‚

## æ ¹æœ¬åŸå› 

åœ¨ `process_transcription_task` ä¸­ï¼Œæˆ‘ä¹‹å‰åŠ å…¥çš„ç¨‹å¼ç¢¼ï¼š

```python
task_data = run_async_in_thread(get_task_from_db(task_id))  # âŒ é˜»å¡å¼ DB æŸ¥è©¢
```

é€™å°è‡´ **executor ç·šç¨‹æ± æ­»é–**ï¼š

1. **å¤–å±¤ executor**ï¼ˆmax_workers=5ï¼‰åŸ·è¡Œ `process_transcription_task`
2. ä»»å‹™å•Ÿå‹•æ™‚åŸ·è¡Œ `run_async_in_thread()` â†’ **é˜»å¡ç·šç¨‹ç­‰å¾… DB æŸ¥è©¢**
3. **å…§å±¤ executor**ï¼ˆmax_workers=2-4ï¼‰è™•ç†ä¸¦è¡Œè½‰éŒ„ â†’ **ä½”ç”¨æ›´å¤šç·šç¨‹**
4. å‰ç«¯è¼ªè©¢è«‹æ±‚é€²ä¾† â†’ **æ‰€æœ‰ç·šç¨‹éƒ½å¿™ç¢Œ/é˜»å¡**
5. **æ­»é–**ï¼å¾Œç«¯åœæ­¢å›æ‡‰

## ä¿®å¾©æ–¹æ¡ˆ

### ä¿®æ”¹ 1ï¼šå‡½æ•¸ç°½åå¢åŠ  user_id åƒæ•¸

**æª”æ¡ˆ**: `src/whisper_server.py:1816-1827`

```python
def process_transcription_task(
    task_id: str,
    temp_audio_path: Path,
    filename: str,
    punct_provider: str,
    chunk_audio: bool,
    chunk_minutes: int,
    diarize: bool = False,
    max_speakers: Optional[int] = None,
    language: str = "zh",
    user_id: str = None  # âœ… æ–°å¢åƒæ•¸
):
```

### ä¿®æ”¹ 2ï¼šç›´æ¥åˆå§‹åŒ–è¨˜æ†¶é«”ï¼Œç§»é™¤é˜»å¡å¼ DB æŸ¥è©¢

**æª”æ¡ˆ**: `src/whisper_server.py:1849-1857`

```python
# åˆå§‹åŒ–è¨˜æ†¶é«”ï¼šç›´æ¥è¨­ç½® user_idï¼Œé¿å…é˜»å¡å¼ DB æŸ¥è©¢
if user_id:
    with tasks_lock:
        if task_id not in transcription_tasks:
            transcription_tasks[task_id] = {}
        # å„²å­˜ user_idï¼ˆæ”¯æ´å·¢ç‹€å’Œæ‰å¹³å…©ç¨®æ ¼å¼ï¼‰
        transcription_tasks[task_id]["user"] = {"user_id": user_id}
        transcription_tasks[task_id]["user_id"] = user_id  # æ‰å¹³æ ¼å¼ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    print(f"ğŸ“¥ [{task_id}] åˆå§‹åŒ–è¨˜æ†¶é«”ï¼ˆuser_id: {user_id}ï¼‰ï¼Œä¹‹å¾Œè¼ªè©¢å°‡é›¶ DB æŸ¥è©¢")
```

**é—œéµæ”¹é€²**ï¼š
- âŒ ç§»é™¤ï¼š`run_async_in_thread(get_task_from_db(task_id))` - é˜»å¡å¼ DB æŸ¥è©¢
- âœ… æ”¹ç”¨ï¼šç›´æ¥å¾åƒæ•¸å‚³é user_id - **ä¸é˜»å¡ç·šç¨‹**

### ä¿®æ”¹ 3ï¼šå‚³é user_id åˆ°å‡½æ•¸

**æª”æ¡ˆ**: `src/whisper_server.py:2507-2522`

```python
loop.run_in_executor(
    executor,
    process_transcription_task,
    task_id,
    temp_audio,
    file.filename,
    punct_provider,
    chunk_audio,
    chunk_minutes,
    diarize,
    max_speakers,
    language,
    str(current_user["_id"])  # âœ… å‚³é user_id
)
```

## æ•ˆæœ

### ä¹‹å‰ï¼ˆæ­»é–ï¼‰
1. ä»»å‹™å•Ÿå‹• â†’ é˜»å¡ç­‰å¾… DB æŸ¥è©¢ â†’ ç·šç¨‹è¢«ä½”ç”¨
2. ä¸¦è¡Œè½‰éŒ„å•Ÿå‹• â†’ ä½”ç”¨æ›´å¤šç·šç¨‹
3. å‰ç«¯è¼ªè©¢ â†’ æ²’æœ‰ç©ºé–’ç·šç¨‹è™•ç† â†’ **è¶…æ™‚**

### ç¾åœ¨ï¼ˆæ­£å¸¸ï¼‰
1. ä»»å‹™å•Ÿå‹• â†’ ç›´æ¥è¨­ç½® user_id åˆ°è¨˜æ†¶é«” â†’ **ä¸é˜»å¡**
2. ä¸¦è¡Œè½‰éŒ„å•Ÿå‹• â†’ ä½¿ç”¨ç¨ç«‹ç·šç¨‹æ± 
3. å‰ç«¯è¼ªè©¢ â†’ å¾è¨˜æ†¶é«”è®€å– â†’ **ç«‹å³è¿”å›**

## æ¸¬è©¦æ­¥é©Ÿ

1. âœ… å¾Œç«¯å·²é‡å•Ÿï¼ˆPID: 25640ï¼‰
2. âš ï¸ ä¹‹å‰ä¸­æ–·çš„ä»»å‹™å·²è‡ªå‹•æ¨™è¨˜ç‚ºå¤±æ•—

ç¾åœ¨å¯ä»¥é‡æ–°ä¸Šå‚³é‚£å€‹ 67MB éŸ³æª”æ¸¬è©¦ï¼š

### é æœŸæ—¥èªŒè¼¸å‡º

```
ğŸ“¥ [task_id] åˆå§‹åŒ–è¨˜æ†¶é«”ï¼ˆuser_id: xxxï¼‰ï¼Œä¹‹å¾Œè¼ªè©¢å°‡é›¶ DB æŸ¥è©¢
ğŸ”„ [task_id] In-memory progress: æ­£åœ¨è½‰æ›éŸ³è¨Šæ ¼å¼...
âš¡ [task_id] å¾è¨˜æ†¶é«”è¿”å›ï¼ˆé›¶ DB æŸ¥è©¢ï¼‰  â† å‰ç«¯è¼ªè©¢æˆåŠŸ
âš¡ [task_id] å¾è¨˜æ†¶é«”è¿”å›ï¼ˆé›¶ DB æŸ¥è©¢ï¼‰  â† æŒçºŒè¼ªè©¢æˆåŠŸ
ğŸš€ é–‹å§‹ä¸¦è¡Œè½‰éŒ„ï¼ˆä¸¦è¡Œæ•¸ï¼š2ï¼‰...
âš¡ [task_id] å¾è¨˜æ†¶é«”è¿”å›ï¼ˆé›¶ DB æŸ¥è©¢ï¼‰  â† è½‰éŒ„æœŸé–“ä»ç„¶å¯ä»¥è¼ªè©¢ï¼
```

### ç›£æ§å‘½ä»¤

```bash
# å³æ™‚ç›£æ§è¨˜æ†¶é«”
./monitor_memory.sh

# æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ
tail -f backend.log
```

## é¡å¤–å„ªåŒ–

å¦‚æœä»æœ‰å•é¡Œï¼Œå¯èƒ½éœ€è¦ï¼š

1. **å¢åŠ  executor workers**ï¼ˆç›®å‰ 5 å€‹ï¼‰
2. **æ¸›å°‘ä¸¦è¡Œè½‰éŒ„æ•¸**ï¼ˆç›®å‰ 2-4 å€‹ï¼‰
3. **é—œé–‰èªªè©±è€…è¾¨è­˜**ï¼ˆæ¸›å°‘èƒŒæ™¯ä»»å‹™ï¼‰

## æŠ€è¡“ç­†è¨˜

**ç‚ºä»€éº¼ä¸èƒ½åœ¨ executor ä¸­ä½¿ç”¨ `run_async_in_thread`ï¼Ÿ**

`run_async_in_thread` ä½¿ç”¨ `future.result()` é˜»å¡ç•¶å‰ç·šç¨‹ç­‰å¾… async æ“ä½œå®Œæˆã€‚ç•¶æ‰€æœ‰ executor ç·šç¨‹éƒ½è¢«é˜»å¡æ™‚ï¼Œæ²’æœ‰ç·šç¨‹å¯ä»¥è™•ç†æ–°çš„è«‹æ±‚ â†’ æ­»é–ã€‚

**æ­£ç¢ºåšæ³•**ï¼š
- åœ¨åŒæ­¥ç’°å¢ƒï¼ˆexecutorï¼‰ä¸­ï¼Œé¿å…èª¿ç”¨éœ€è¦é˜»å¡ç­‰å¾…çš„ async æ“ä½œ
- æ”¹ç”¨åƒæ•¸å‚³éã€ç›´æ¥è¨­ç½®ç­‰éé˜»å¡æ–¹å¼
